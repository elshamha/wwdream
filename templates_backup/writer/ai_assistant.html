{% extends 'base.html' %}
{% block title %}AI Writing Assistant - A Writer's Web Dream{% endblock %}

{% block extra_css %}
<style>
    .ai-chat-container {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background: #f8f9fa;
    }
    .ai-response {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 0.5rem 0;
        border-left: 4px solid #007bff;
    }
    .user-input {
        background: #e3f2fd;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 0.5rem 0;
        border-left: 4px solid #2196f3;
    }
    .typing-indicator {
        display: none;
        padding: 1rem;
        font-style: italic;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-robot text-primary me-2"></i>
            AI Writing Assistant
        </h1>
        <p class="lead text-muted">Get help with brainstorming, editing, grammar checks, and more!</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-comments me-2"></i>
                    Writing Assistant Chat
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="ai-chat-container" id="chatContainer">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <h5>Hello! I'm your AI writing assistant.</h5>
                        <p>I can help you with brainstorming, editing, grammar checks, and more. What would you like help with today?</p>
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <i class="fas fa-circle-notch fa-spin me-2"></i>AI is thinking...
                </div>
            </div>
            <div class="card-footer">
                <form id="aiAssistantForm" method="post">
                    {% csrf_token %}
                    <div class="row g-2">
                        <div class="col-md-3">
                            {{ form.assistance_type }}
                        </div>
                        <div class="col-md-9">
                            {{ form.content }}
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-md-9">
                            {{ form.prompt }}
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-paper-plane me-1"></i>Ask AI
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb text-warning me-2"></i>
                    Quick Tips
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item border-0 px-0">
                        <strong>Brainstorming:</strong> Ask for plot ideas, character development, or world-building suggestions.
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <strong>Editing:</strong> Get suggestions for improving flow, pacing, and clarity.
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <strong>Continue Writing:</strong> Stuck? Ask AI to suggest how to continue your scene.
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <strong>Grammar Check:</strong> Get help with grammar, punctuation, and style.
                    </div>
                    <div class="list-group-item border-0 px-0">
                        <strong>Rewrite:</strong> Ask for alternative ways to express your ideas.
                    </div>
                </div>
            </div>
        </div>
        
        {% if recent_requests %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Requests
                </h5>
            </div>
            <div class="card-body">
                {% for request in recent_requests %}
                <div class="border-bottom pb-2 mb-2">
                    <small class="text-muted d-block">{{ request.get_assistance_type_display }}</small>
                    <small class="text-truncate d-block" style="max-width: 200px;">
                        {{ request.content|truncatewords:10 }}
                    </small>
                    <small class="text-muted">{{ request.created_at|timesince }} ago</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-magic text-purple me-2"></i>
                    Writing Prompts
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm prompt-btn" data-prompt="Help me brainstorm ideas for a fantasy adventure story">
                        Fantasy Adventure Ideas
                    </button>
                    <button class="btn btn-outline-success btn-sm prompt-btn" data-prompt="I need help developing a complex villain character">
                        Character Development
                    </button>
                    <button class="btn btn-outline-info btn-sm prompt-btn" data-prompt="How can I improve this dialogue scene?">
                        Dialogue Tips
                    </button>
                    <button class="btn btn-outline-warning btn-sm prompt-btn" data-prompt="I'm stuck on how to end this chapter dramatically">
                        Plot Development
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Handle form submission
    $('#aiAssistantForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const content = $('#id_content').val();
        const assistanceType = $('#id_assistance_type option:selected').text();
        const prompt = $('#id_prompt').val();
        
        if (!content.trim()) {
            alert('Please enter some content for the AI to help with.');
            return;
        }
        
        // Add user input to chat
        addToChatContainer('user', `${assistanceType}: ${content}${prompt ? '\n\nAdditional context: ' + prompt : ''}`);
        
        // Show typing indicator
        $('#typingIndicator').show();
        
        // Submit form via AJAX
        $.ajax({
            url: '',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#typingIndicator').hide();
                if (response.status === 'success') {
                    addToChatContainer('ai', response.response);
                    // Clear form
                    $('#id_content').val('');
                    $('#id_prompt').val('');
                } else {
                    addToChatContainer('ai', 'Sorry, I encountered an error. Please try again.');
                }
            },
            error: function() {
                $('#typingIndicator').hide();
                addToChatContainer('ai', 'Sorry, I encountered an error. Please try again.');
            }
        });
    });
    
    // Handle quick prompt buttons
    $('.prompt-btn').on('click', function() {
        const prompt = $(this).data('prompt');
        $('#id_content').val(prompt);
        $('#id_assistance_type').val('brainstorm');
    });
    
    function addToChatContainer(type, message) {
        const chatContainer = $('#chatContainer');
        const messageClass = type === 'user' ? 'user-input' : 'ai-response';
        const icon = type === 'user' ? 'fas fa-user' : 'fas fa-robot';
        
        const messageHtml = `
            <div class="${messageClass}">
                <div class="d-flex align-items-start">
                    <i class="${icon} me-2 mt-1"></i>
                    <div class="flex-grow-1">
                        <div style="white-space: pre-wrap;">${message}</div>
                    </div>
                </div>
            </div>
        `;
        
        chatContainer.append(messageHtml);
        chatContainer.scrollTop(chatContainer[0].scrollHeight);
    }
});
</script>
{% endblock %}
