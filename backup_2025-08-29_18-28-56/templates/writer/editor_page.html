{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">A Writer's Web Processor</h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <input type="text" id="ckeditor-title" name="title" class="form-control mb-3" placeholder="Chapter Title" value="{{ chapter.title|default:'' }}" required>
                        <div id="ckeditor-pagination-container" style="width:100%;">
                            <textarea id="ckeditor-content" name="content" style="min-height:600px;height:600px;width:100%;resize:vertical;">{{ chapter.content|default:'' }}</textarea>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" onclick="saveCKEditor()">Save</button>
                            <span class="ms-auto align-self-center" id="ckeditor-autosave-status" style="font-size:0.95em;color:#888;">Autosave: Enabled</span>
                        </div>
                    </form>
                </div>
            </div>
            <div id="ckeditor-save-status" class="mt-3"></div>
        </div>
    </div>
</div>

<!-- CKEditor 5 Classic CDN -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.2.1/classic/ckeditor.js"></script>
<script>
// Auto-save and local backup
let autosaveTimeout = null;
function autoSaveCKEditor() {
    if (autosaveTimeout) clearTimeout(autosaveTimeout);
    autosaveTimeout = setTimeout(() => {
        const title = document.getElementById('ckeditor-title').value;
        const content = window.ckeditorInstance.getData();
        localStorage.setItem('editorDraft', JSON.stringify({ title, content }));
        document.getElementById('ckeditor-autosave-status').textContent = 'Autosave: Draft saved locally.';
    }, 1500);
}

function restoreDraft() {
    const draft = localStorage.getItem('editorDraft');
    if (draft) {
        try {
            const { title, content } = JSON.parse(draft);
            document.getElementById('ckeditor-title').value = title || '';
            window.ckeditorInstance.setData(content || '');
            document.getElementById('ckeditor-autosave-status').textContent = 'Autosave: Draft recovered.';
        } catch {}
    }
}

function saveCKEditor(showMessage=true) {
    const title = document.getElementById('ckeditor-title').value;
    const content = window.ckeditorInstance.getData();
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: new URLSearchParams({
            action: 'save',
            title: title,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (showMessage) {
            document.getElementById('ckeditor-save-status').textContent = data.status === 'success' ? 'Saved!' : (data.message || 'Save failed.');
        }
        // Remove local draft after successful save
        if (data.status === 'success') localStorage.removeItem('editorDraft');
    })
    .catch(() => {
        if (showMessage) document.getElementById('ckeditor-save-status').textContent = 'Error saving.';
    });
}
    toolbar: [],
    heading: { options: [] },
    removePlugins: [
        'Heading', 'HeadingButtonsUI', 'Title', 'BlockToolbar',
        'BalloonToolbar', 'ContextMenu', 'List', 'ListProperties',
        'Table', 'TableToolbar', 'TableProperties', 'TableCellProperties',
        'TableColumnResize', 'TableCaption', 'TableCellSelection',
        'TableSelection', 'TableKeyboard', 'TableMouse', 'TableUtils',
        'TableWalker', 'TableClipboard', 'TableEditing', 'TableUI',
    ],
}).then(editor => {
    editor.ui.view.editable.element.style.minHeight = '600px';
    editor.ui.view.editable.element.style.height = '600px';
    editor.ui.view.editable.element.style.width = '100%';
    editor.ui.view.editable.element.style.resize = 'vertical';
    editor.ui.view.editable.element.style.color = '#000';
    editor.ui.view.editable.element.style.background = '#fff';
    editor.ui.view.editable.element.style.opacity = '1';
    editor.ui.view.editable.element.style.filter = 'none';
    // Remove the textarea from the DOM after CKEditor is initialized
    const ta = document.getElementById('ckeditor-content');
    if (ta) ta.parentNode.removeChild(ta);
    window.ckeditorInstance = editor;
    // Restore draft on load
    restoreDraft();
    // Auto-save on change
    editor.model.document.on('change:data', autoSaveCKEditor);
}).catch(error => { console.error(error); });

function saveCKEditor(showMessage=true) {
    const title = document.getElementById('ckeditor-title').value;
    const content = window.ckeditorInstance.getData();
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: new URLSearchParams({
            action: 'save',
            title: title,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (showMessage) {
            document.getElementById('ckeditor-save-status').textContent = data.status === 'success' ? 'Saved!' : (data.message || 'Save failed.');
        }
    })
    .catch(() => {
        if (showMessage) document.getElementById('ckeditor-save-status').textContent = 'Error saving.';
    });
}
</script>
{% endblock %}
